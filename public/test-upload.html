<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Upload - Lambari na Tela</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .upload-form { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .result { margin: 20px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Teste de Upload de Arquivos</h1>

    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <strong>‚ö†Ô∏è Importante:</strong> Este arquivo deve ser acessado via <code>http://localhost:8080/test-upload.html</code> no navegador,
        n√£o aberto diretamente como arquivo local. Caso contr√°rio, haver√° problemas de CORS.
    </div>

    <div class="upload-form">
        <h3>Enviar Arquivo</h3>
        <form id="uploadForm">
            <input type="file" id="fileInput" accept="image/*,video/*" required>
            <button type="submit">Enviar</button>
        </form>
    </div>

    <div id="result" class="result" style="display: none;"></div>

    <script>
        // Verificar se estamos na origem correta
        if (window.location.protocol !== 'http:' && window.location.protocol !== 'https:') {
            document.body.innerHTML = `
                <h1>Erro de Configura√ß√£o</h1>
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 20px 0; border-radius: 5px; color: #721c24;">
                    <strong>Erro:</strong> Esta p√°gina deve ser acessada via HTTP (http://localhost:8080/test-upload.html), n√£o como arquivo local.<br>
                    Abra seu navegador e acesse: <code>http://localhost:8080/test-upload.html</code>
                </div>
            `;
        } else {
            // Verificar se as depend√™ncias est√£o carregadas
            window.addEventListener('load', () => {
                console.log('üîç Verificando depend√™ncias...');
                console.log('SupabaseUtils dispon√≠vel:', typeof window.SupabaseUtils);
                console.log('uploadFileLocally dispon√≠vel:', typeof window.SupabaseUtils?.uploadFileLocally);
                console.log('submitToSupabase dispon√≠vel:', typeof window.SupabaseUtils?.submitToSupabase);

                if (typeof window.SupabaseUtils === 'undefined') {
                    console.error('‚ùå SupabaseUtils n√£o carregado!');
                    document.body.innerHTML += `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 20px 0; border-radius: 5px; color: #721c24;">
                            <strong>Erro:</strong> SupabaseUtils n√£o foi carregado. Verifique se supabase-utils.js est√° sendo inclu√≠do corretamente.
                        </div>
                    `;
                    return;
                }

                // C√≥digo do formul√°rio s√≥ executa se estiver na origem correta e depend√™ncias carregadas
                document.getElementById('uploadForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const fileInput = document.getElementById('fileInput');
                    const resultDiv = document.getElementById('result');

                    if (!fileInput.files[0]) {
                        showResult('Por favor, selecione um arquivo.', 'error');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);

                    try {
                        console.log('üöÄ Iniciando upload...');
                        console.log('Arquivo selecionado:', fileInput.files[0].name, 'Tamanho:', fileInput.files[0].size);

                        const response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });

                        console.log('üì° Resposta do servidor - Status:', response.status);
                        console.log('üì° Headers:', Object.fromEntries(response.headers.entries()));

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('‚ùå Erro na resposta:', errorText);
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }

                        const data = await response.json();
                        console.log('‚úÖ Dados recebidos:', data);

                        if (data.success) {
                            const imageUrl = `http://localhost:8080${data.filepath}`;
                            showResult(`
                                <strong>‚úÖ Upload realizado com sucesso!</strong><br>
                                Arquivo: ${data.filename}<br>
                                <a href="${imageUrl}" target="_blank">üìÅ Ver arquivo</a>
                            `, 'success');
                        } else {
                            showResult(`‚ùå Erro: ${data.error}`, 'error');
                        }
                    } catch (error) {
                        console.error('üí• Erro completo:', error);
                        showResult(`‚ùå Erro de rede: ${error.message}`, 'error');
                    }
                });
            });
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }
    </script>
</body>
</html>