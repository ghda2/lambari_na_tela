<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria de Registros - Lambari na Tela</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .card-body {
            padding: 20px;
        }

        .card-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .card-info {
            font-size: 0.9em;
            color: #666;
            line-height: 1.6;
        }

        .card-info p {
            margin-bottom: 8px;
        }

        .card-info strong {
            color: #333;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .image-thumb {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .image-thumb:hover {
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .empty {
            text-align: center;
            padding: 60px 20px;
            color: white;
            font-size: 1.1em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            margin: auto;
            padding: 30px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            background: white;
            border-radius: 15px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            h1 {
                font-size: 1.8em;
            }

            .images-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“¸ Galeria de Registros</h1>

        <div class="filters">
            <button class="filter-btn active" onclick="filterByType('all')">Todos</button>
            <button class="filter-btn" onclick="filterByType('pets_perdidos')">ðŸ¾ Pets Perdidos</button>
            <button class="filter-btn" onclick="filterByType('objetos_perdidos')">ðŸ“¦ Objetos Perdidos</button>
            <button class="filter-btn" onclick="filterByType('reportagens')">ðŸ“¢ Reportagens</button>
        </div>

        <div id="gallery" class="gallery"></div>
        <div id="loading" class="loading">Carregando registros...</div>
        <div id="error" class="error" style="display:none;"></div>
        <div id="empty" class="empty" style="display:none;">Nenhum registro encontrado.</div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <img id="modalImage" style="width: 100%; border-radius: 10px;">
        </div>
    </div>

    <script>
        let allData = {};
        let currentFilter = 'all';

        const DIRECTUS_URL = 'http://localhost:8055';
        const COLLECTIONS = ['pets_perdidos', 'objetos_perdidos', 'reportagens'];

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('gallery').innerHTML = '';

                // Carregar dados de todas as coleÃ§Ãµes
                for (const collection of COLLECTIONS) {
                    try {
                        const response = await fetch(`${DIRECTUS_URL}/items/${collection}?limit=100`);
                        if (response.ok) {
                            const data = await response.json();
                            allData[collection] = data.data || [];
                        }
                    } catch (e) {
                        console.error(`Erro ao carregar ${collection}:`, e);
                    }
                }

                document.getElementById('loading').style.display = 'none';
                renderGallery();
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Erro ao carregar registros: ' + error.message;
            }
        }

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            let count = 0;

            for (const [collection, items] of Object.entries(allData)) {
                if (currentFilter !== 'all' && currentFilter !== collection) continue;

                items.forEach(item => {
                    count++;
                    const card = createCard(item, collection);
                    gallery.appendChild(card);
                });
            }

            if (count === 0) {
                document.getElementById('empty').style.display = 'block';
            } else {
                document.getElementById('empty').style.display = 'none';
            }
        }

        function createCard(item, collection) {
            const card = document.createElement('div');
            card.className = 'card';

            let titleKey = 'nome_pet';
            let subtitleKey = 'tipo_pet';
            let imageFieldKey = 'img_path';

            if (collection === 'objeto_perdido') {
                titleKey = 'objeto_perdido';
                subtitleKey = 'descricao_detalhada';
                imageFieldKey = 'fotos';
            } else if (collection === 'propaganda') {
                titleKey = 'nome_empresa';
                subtitleKey = 'tipo_negocio';
                imageFieldKey = 'materiais_divulgacao';
            }

            const title = item[titleKey] || 'Sem tÃ­tulo';
            const subtitle = item[subtitleKey] || '';
            const images = getImages(item[imageFieldKey]);
            const imageUrl = images.length > 0 ? images[0] : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="300" height="250"%3E%3Crect fill="%23ddd" width="300" height="250"/%3E%3Ctext x="50%25" y="50%25" font-size="20" fill="%23999" text-anchor="middle" dy=".3em"%3ESem imagem%3C/text%3E%3C/svg%3E';

            card.innerHTML = `
                <img src="${imageUrl}" alt="${title}" class="card-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22250%22%3E%3Crect fill=%22%23ddd%22 width=%22300%22 height=%22250%22/%3E%3C/svg%3E'">
                <div class="card-body">
                    <div class="card-title">${escapeHtml(title)}</div>
                    <div class="card-info">
                        <p><strong>Tipo:</strong> ${escapeHtml(collection.replace('_', ' ').toUpperCase())}</p>
                        <p><strong>DescriÃ§Ã£o:</strong> ${escapeHtml(subtitle.substring(0, 100))}</p>
                    </div>
                    ${images.length > 1 ? `
                    <div class="images-grid">
                        ${images.slice(0, 3).map(img => `
                            <img src="${img}" alt="thumb" class="image-thumb" onclick="openModal(this.src)">
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            `;

            return card;
        }

        function getImages(imageField) {
            if (!imageField) return [];

            // Se Ã© string JSON, fazer parse
            if (typeof imageField === 'string') {
                try {
                    imageField = JSON.parse(imageField);
                } catch {
                    // Se nÃ£o conseguir fazer parse, tentar como URL direta
                    return [imageField];
                }
            }

            // Se Ã© array, mapear para URLs do Directus
            if (Array.isArray(imageField)) {
                return imageField.map(id => `${DIRECTUS_URL}/assets/${id}`);
            }

            // Se Ã© um ID direto
            if (typeof imageField === 'string') {
                return [`${DIRECTUS_URL}/assets/${imageField}`];
            }

            return [];
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function filterByType(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderGallery();
        }

        function openModal(src) {
            document.getElementById('imageModal').style.display = 'block';
            document.getElementById('modalImage').src = src;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Carregar dados ao iniciar
        loadData();

        // Recarregar dados a cada 30 segundos
        setInterval(loadData, 30000);
    </script>
</body>
</html>
